# 01_ARCHITECTURE.md - PostHub.work

**Dokument:** TechnickÃ¡ Architektura  
**Verze:** 2.1.0  
**ÃšÄel:** KompletnÃ­ technickÃ½ pÅ™ehled systÃ©mu  
**Status:** âœ… AktualizovÃ¡no na skuteÄnÃ½ stav nasazenÃ­  
**PoslednÃ­ aktualizace:** December 17, 2025

---

## ğŸ“‹ OBSAH

1. [PÅ™ehled Architektury](#1-pÅ™ehled-architektury)
2. [Komponenty SystÃ©mu](#2-komponenty-systÃ©mu)
3. [Data Flow](#3-data-flow)
4. [Tech Stack](#4-tech-stack)
5. [Module Structure](#5-module-structure)
6. [Integration Points](#6-integration-points)
7. [Scalability Patterns](#7-scalability-patterns)
8. [Deployment Architecture](#8-deployment-architecture)
9. [Security Architecture](#9-security-architecture)
10. [Monitoring & Observability](#10-monitoring--observability)
11. [Decision Log](#11-decision-log)
12. [Migration Path](#12-migration-path)

---

## 1. PÅ˜EHLED ARCHITEKTURY

### 1.1 High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          POSTHUB ARCHITECTURE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         FRONTEND LAYER                                â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚  â”‚  Angular 19 SPA    â”‚    â”‚   Tailwind CSS 3.4 â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚  - NgRx Store      â”‚    â”‚   - Custom Theme   â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚  - Signals API     â”‚    â”‚   - 35+ Components â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚  - TypeScript 5.3  â”‚    â”‚   - Visual Book    â”‚                   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚ HTTPS/REST API                          â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      REVERSE PROXY LAYER                              â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Host Nginx (72.62.92.89)                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - HTTP on port 80 (SSL pending)                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Proxy to backend:8000                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Static files serving                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Certbot ready (not activated)                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚                                          â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        BACKEND LAYER                                  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚  â”‚  Django 5.x API    â”‚    â”‚   Celery Workers   â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚  - Python 3.12     â”‚    â”‚   - Quick: 4x      â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚  - DRF             â”‚    â”‚   - AI: 2x         â”‚                   â”‚  â”‚
â”‚  â”‚  â”‚  - JWT Auth        â”‚    â”‚   - Scheduled: 1x  â”‚                   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â”‚           â”‚                          â”‚                                â”‚  â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚  â”‚
â”‚  â”‚                          â”‚                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                                               â”‚
â”‚                             â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      DATA LAYER                                       â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ PostgreSQL   â”‚    â”‚   Redis 7    â”‚    â”‚  File Storageâ”‚           â”‚  â”‚
â”‚  â”‚  â”‚   16+pgvectorâ”‚    â”‚  - Cache     â”‚    â”‚   /media     â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  93 tables   â”‚    â”‚  - Broker    â”‚    â”‚   /static    â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   EXTERNAL SERVICES                                   â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚  Gemini  â”‚  â”‚Perplexityâ”‚  â”‚ Nanobana â”‚  â”‚   Veo 3  â”‚            â”‚  â”‚
â”‚  â”‚  â”‚  (Text)  â”‚  â”‚  (DNA)   â”‚  â”‚  (Image) â”‚  â”‚  (Video) â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚  â”‚
â”‚  â”‚  â”‚  Stripe  â”‚  â”‚  GitHub  â”‚                                          â”‚  â”‚
â”‚  â”‚  â”‚(Payments)â”‚  â”‚   (CI)   â”‚                                          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Architectural Style

**AktuÃ¡lnÃ­ stav:** Modular Monolith  
**Deployment:** Single VPS with Docker Compose  
**Future plan:** Kubernetes cluster (post-funding)

#### Design Principles

1. **Multi-tenancy:** Row-based isolation (Organization FK na vÅ¡ech modelech)
2. **Separation of Concerns:** Backend API + Frontend SPA
3. **Asynchronous Processing:** Celery pro AI operace (30-120s tasks)
4. **Scalability Ready:** PÅ™ipraveno na horizontÃ¡lnÃ­ Å¡kÃ¡lovÃ¡nÃ­
5. **Security First:** JWT auth + RBAC + tenant isolation

---

## 2. KOMPONENTY SYSTÃ‰MU

### 2.1 Frontend Components

```typescript
// Angular 19 Architecture
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ core/              // Singleton services
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ guards/
â”‚   â”‚   â”œâ”€â”€ shared/            // Reusable components (35+)
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ directives/
â”‚   â”‚   â”‚   â””â”€â”€ pipes/
â”‚   â”‚   â”œâ”€â”€ features/          // Feature modules
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”œâ”€â”€ manager/
â”‚   â”‚   â”‚   â”œâ”€â”€ marketer/
â”‚   â”‚   â”‚   â””â”€â”€ supervisor/
â”‚   â”‚   â””â”€â”€ store/             // NgRx State Management
â”‚   â”‚       â”œâ”€â”€ auth/
â”‚   â”‚       â”œâ”€â”€ organizations/
â”‚   â”‚       â””â”€â”€ content/
â”‚   â””â”€â”€ styles/
â”‚       â”œâ”€â”€ tailwind.css
â”‚       â””â”€â”€ visual-book/       // Custom design system
```

**Key Technologies:**
- **Angular 19:** Signals API, Standalone Components
- **NgRx 18:** State management, Effects, Selectors
- **Tailwind CSS 3.4:** Utility-first styling
- **TypeScript 5.3:** Type safety
- **RxJS 7:** Reactive programming

### 2.2 Backend Components

```python
# Django Project Structure
backend/
â”œâ”€â”€ config/                    # Django settings
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ base.py
â”‚   â”‚   â”œâ”€â”€ development.py
â”‚   â”‚   â””â”€â”€ production.py
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ celery.py
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ users/                 # User management + RBAC
â”‚   â”œâ”€â”€ organizations/         # Multi-tenancy root
â”‚   â”œâ”€â”€ companies/             # Company profiles + DNA
â”‚   â”œâ”€â”€ personas/              # AI personas
â”‚   â”œâ”€â”€ content/               # Content management
â”‚   â”‚   â”œâ”€â”€ topics/
â”‚   â”‚   â”œâ”€â”€ blog_posts/
â”‚   â”‚   â””â”€â”€ social_posts/
â”‚   â”œâ”€â”€ billing/               # Stripe integration
â”‚   â”œâ”€â”€ ai_gateway/            # AI provider abstraction
â”‚   â””â”€â”€ core/                  # Shared utilities
â””â”€â”€ celery_app/
    â”œâ”€â”€ tasks/
    â”‚   â”œâ”€â”€ ai_tasks.py
    â”‚   â”œâ”€â”€ content_tasks.py
    â”‚   â””â”€â”€ billing_tasks.py
    â””â”€â”€ schedules.py
```

**Key Technologies:**
- **Django 5.x:** Web framework
- **Django REST Framework 3.14:** API layer
- **Celery 5.3:** Task queue
- **PostgreSQL 16:** Primary database
- **Redis 7:** Cache + Broker

### 2.3 Database Schema (93 Tables)

```sql
-- Core Tenancy
organizations
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ name
  â”œâ”€â”€ subscription_tier
  â””â”€â”€ created_at

-- User Management (django-admin + custom)
users
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ email (unique)
  â”œâ”€â”€ role (ADMIN/MANAGER/MARKETER/SUPERVISOR)
  â””â”€â”€ organization_id (FK, nullable for staff)

-- Content Hierarchy
companies
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ organization_id (FK)
  â”œâ”€â”€ name
  â”œâ”€â”€ dna_data (JSONB)
  â””â”€â”€ created_at

personas
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ company_id (FK)
  â”œâ”€â”€ name
  â”œâ”€â”€ style_description
  â””â”€â”€ is_active

topics
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ persona_id (FK)
  â”œâ”€â”€ title
  â”œâ”€â”€ status (DRAFT/APPROVED/REJECTED)
  â””â”€â”€ scheduled_date

blog_posts
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ topic_id (FK)
  â”œâ”€â”€ content (TEXT)
  â”œâ”€â”€ status
  â””â”€â”€ metadata (JSONB)

social_posts
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ blog_post_id (FK)
  â”œâ”€â”€ platform
  â”œâ”€â”€ content
  â”œâ”€â”€ media_url
  â””â”€â”€ scheduled_at

-- Billing (dj-stripe)
djstripe_customer
djstripe_subscription
djstripe_invoice
djstripe_paymentmethod
... (20+ billing tables)

-- AI Tasks
ai_tasks
  â”œâ”€â”€ id (UUID, PK)
  â”œâ”€â”€ task_type
  â”œâ”€â”€ status
  â”œâ”€â”€ celery_task_id
  â”œâ”€â”€ progress (0-100)
  â””â”€â”€ result (JSONB)
```

**Key Features:**
- âœ… UUID primary keys
- âœ… Soft deletes (is_deleted flag)
- âœ… Timestamps (created_at, updated_at)
- âœ… Tenant isolation (organization FK)
- âœ… JSONB for flexible data (DNA, metadata)
- âœ… pgvector for AI embeddings (future use)

---

## 3. DATA FLOW

### 3.1 Content Generation Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI CONTENT GENERATION PIPELINE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. SUPERVISOR REGISTRATION & ONBOARDING                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  User Input â†’ Company Search â†’ DNA Scraping (Perplexity)           â”‚    â”‚
â”‚  â”‚  â””â”€â†’ Organization Created â†’ Company Created â†’ DNA Stored            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  2. PERSONA GENERATION                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trigger: User clicks "Generate Personas"                           â”‚    â”‚
â”‚  â”‚  Process:                                                            â”‚    â”‚
â”‚  â”‚    - Celery Task (ai_jobs queue)                                    â”‚    â”‚
â”‚  â”‚    - Load Company DNA                                               â”‚    â”‚
â”‚  â”‚    - Call Gemini API (generate 6 personas)                          â”‚    â”‚
â”‚  â”‚    - Store in DB with status=DRAFT                                  â”‚    â”‚
â”‚  â”‚  Output: 6 Persona objects                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  3. PERSONA SELECTION & ACTIVATION                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  User selects 3/6/12 personas (based on tier)                      â”‚    â”‚
â”‚  â”‚  â””â”€â†’ is_active = True                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  4. TOPIC GENERATION (Monthly)                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trigger: Subscription started OR previous topics approved          â”‚    â”‚
â”‚  â”‚  Process:                                                            â”‚    â”‚
â”‚  â”‚    - Celery Task (ai_priority queue)                                â”‚    â”‚
â”‚  â”‚    - For each active persona                                        â”‚    â”‚
â”‚  â”‚    - Consider: DNA, past topics, events, tier limits                â”‚    â”‚
â”‚  â”‚    - Call Gemini API                                                â”‚    â”‚
â”‚  â”‚    - Store Topics with status=DRAFT                                 â”‚    â”‚
â”‚  â”‚  Output: List of Topic objects                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  5. TOPIC APPROVAL                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Supervisor reviews topics in UI                                    â”‚    â”‚
â”‚  â”‚  â””â”€â†’ Approve â†’ status=APPROVED â†’ Triggers blog generation           â”‚    â”‚
â”‚  â”‚  â””â”€â†’ Reject â†’ status=REJECTED â†’ Can request regeneration            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  6. BLOG POST GENERATION                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trigger: Topic.status = APPROVED                                   â”‚    â”‚
â”‚  â”‚  Process:                                                            â”‚    â”‚
â”‚  â”‚    - Celery Task (ai_jobs queue, ~120s)                             â”‚    â”‚
â”‚  â”‚    - Load: Persona, DNA, Documents                                  â”‚    â”‚
â”‚  â”‚    - Call Gemini API (generate 4-10 pages)                          â”‚    â”‚
â”‚  â”‚    - SEO optimization                                               â”‚    â”‚
â”‚  â”‚    - Store BlogPost with status=PENDING_APPROVAL                    â”‚    â”‚
â”‚  â”‚  Output: BlogPost object                                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  7. BLOG APPROVAL                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Supervisor reviews blog in UI                                      â”‚    â”‚
â”‚  â”‚  â””â”€â†’ Approve â†’ status=APPROVED â†’ Triggers social generation         â”‚    â”‚
â”‚  â”‚  â””â”€â†’ Request Changes â†’ Comments â†’ Regeneration                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  8. SOCIAL POST GENERATION                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trigger: BlogPost.status = APPROVED                                â”‚    â”‚
â”‚  â”‚  Process:                                                            â”‚    â”‚
â”‚  â”‚    - Celery Task (ai_jobs queue, ~60s)                              â”‚    â”‚
â”‚  â”‚    - For each selected platform                                     â”‚    â”‚
â”‚  â”‚    - Apply platform constraints                                     â”‚    â”‚
â”‚  â”‚    - Call Gemini API                                                â”‚    â”‚
â”‚  â”‚    - Calculate scheduling                                           â”‚    â”‚
â”‚  â”‚    - Store SocialPost objects                                       â”‚    â”‚
â”‚  â”‚  Output: Multiple SocialPost objects                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  9. IMAGE GENERATION (PRO+ tier)                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trigger: SocialPost created for PRO+ org                           â”‚    â”‚
â”‚  â”‚  Process:                                                            â”‚    â”‚
â”‚  â”‚    - Celery Task (ai_jobs queue, ~90s)                              â”‚    â”‚
â”‚  â”‚    - Extract key message                                            â”‚    â”‚
â”‚  â”‚    - Call Nanobana API                                              â”‚    â”‚
â”‚  â”‚    - Store image URL                                                â”‚    â”‚
â”‚  â”‚  Output: Image attachment                                           â”‚    â”‚
â”‚  â”‚  Status: â³ Planned (not yet implemented)                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  10. VIDEO GENERATION (ULTIMATE tier + add-on)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Trigger: Video event created for ULTIMATE org                      â”‚    â”‚
â”‚  â”‚  Process:                                                            â”‚    â”‚
â”‚  â”‚    - Celery Task (ai_priority queue, ~180s)                         â”‚    â”‚
â”‚  â”‚    - Extract key message                                            â”‚    â”‚
â”‚  â”‚    - Call Veo 3 API                                                 â”‚    â”‚
â”‚  â”‚    - Store video URL                                                â”‚    â”‚
â”‚  â”‚  Output: Video attachment                                           â”‚    â”‚
â”‚  â”‚  Status: â³ Planned (Phase 3)                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  11. FINAL APPROVAL & SCHEDULING                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Supervisor reviews all social posts                                â”‚    â”‚
â”‚  â”‚  â””â”€â†’ Approve â†’ status=APPROVED â†’ Scheduled for delivery             â”‚    â”‚
â”‚  â”‚  â””â”€â†’ Regenerate â†’ New AI task                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AUTHENTICATION FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. LOGIN                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  POST /api/auth/login/                                    â”‚  â”‚
â”‚  â”‚  Body: { email, password }                                â”‚  â”‚
â”‚  â”‚  Response: {                                              â”‚  â”‚
â”‚  â”‚    access_token: "jwt...",   // 60 min expiry            â”‚  â”‚
â”‚  â”‚    refresh_token: "jwt...",  // 7 days expiry            â”‚  â”‚
â”‚  â”‚    user: { id, email, role, organization }               â”‚  â”‚
â”‚  â”‚  }                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  2. AUTHENTICATED REQUEST                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GET /api/organizations/                                  â”‚  â”‚
â”‚  â”‚  Headers: {                                               â”‚  â”‚
â”‚  â”‚    Authorization: "Bearer <access_token>"                 â”‚  â”‚
â”‚  â”‚  }                                                         â”‚  â”‚
â”‚  â”‚  Backend:                                                 â”‚  â”‚
â”‚  â”‚    - Verify JWT signature                                 â”‚  â”‚
â”‚  â”‚    - Extract user_id                                      â”‚  â”‚
â”‚  â”‚    - Check role permissions                               â”‚  â”‚
â”‚  â”‚    - Apply tenant filter (organization_id)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  3. TOKEN REFRESH                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  POST /api/auth/refresh/                                  â”‚  â”‚
â”‚  â”‚  Body: { refresh_token }                                  â”‚  â”‚
â”‚  â”‚  Response: { access_token }                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  4. LOGOUT                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  POST /api/auth/logout/                                   â”‚  â”‚
â”‚  â”‚  - Frontend clears tokens from localStorage              â”‚  â”‚
â”‚  â”‚  - Backend blacklists refresh token (optional)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Celery Task Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CELERY QUEUES                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Queue: DEFAULT (general tasks)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  - Email notifications                                    â”‚  â”‚
â”‚  â”‚  - Data cleanup                                           â”‚  â”‚
â”‚  â”‚  - Report generation                                      â”‚  â”‚
â”‚  â”‚  Concurrency: 4                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Queue: QUICK (fast operations)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  - Status updates                                         â”‚  â”‚
â”‚  â”‚  - Webhooks processing                                    â”‚  â”‚
â”‚  â”‚  - Cache invalidation                                     â”‚  â”‚
â”‚  â”‚  Concurrency: 4                                           â”‚  â”‚
â”‚  â”‚  Max runtime: <10s                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Queue: AI_JOBS (AI generation)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  - Persona generation (~30s)                              â”‚  â”‚
â”‚  â”‚  - Blog post generation (~120s)                           â”‚  â”‚
â”‚  â”‚  - Social post generation (~60s)                          â”‚  â”‚
â”‚  â”‚  - Image generation (~90s, planned)                       â”‚  â”‚
â”‚  â”‚  Concurrency: 2 (rate limiting)                           â”‚  â”‚
â”‚  â”‚  Max runtime: 180s                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Queue: AI_PRIORITY (critical AI tasks)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  - DNA scraping (Perplexity)                             â”‚  â”‚
â”‚  â”‚  - Topic generation                                       â”‚  â”‚
â”‚  â”‚  - Video generation (~180s, planned)                      â”‚  â”‚
â”‚  â”‚  Concurrency: 2                                           â”‚  â”‚
â”‚  â”‚  Max runtime: 240s                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  Queue: SCHEDULED (cron tasks)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  - Daily content scheduling                               â”‚  â”‚
â”‚  â”‚  - Subscription renewals check                            â”‚  â”‚
â”‚  â”‚  - Usage metrics calculation                              â”‚  â”‚
â”‚  â”‚  - Cleanup expired data                                   â”‚  â”‚
â”‚  â”‚  Concurrency: 1                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. TECH STACK

### 4.1 Frontend Stack

```yaml
Framework: Angular 19.0
  - Standalone Components
  - Signals API
  - Dependency Injection
  - Lazy Loading

State Management: NgRx 18.1
  - Store
  - Effects
  - Selectors
  - DevTools

Styling: Tailwind CSS 3.4
  - Custom configuration
  - Visual Book design system
  - 35+ custom components
  - Gradient brand colors
  - Glassmorphism effects

Language: TypeScript 5.3
  - Strict mode
  - Path aliases
  - Type safety

Build Tool: Angular CLI 17
  - Production optimization
  - Ahead-of-Time compilation
  - Tree shaking

Testing:
  - Jasmine (unit tests)
  - Karma (test runner)
  - Cypress (e2e, planned)
```

### 4.2 Backend Stack

```yaml
Framework: Django 5.x
  - REST API only (no templates)
  - Custom user model
  - Multi-database support

API: Django REST Framework 3.14
  - JWT authentication
  - ViewSets & Serializers
  - Pagination
  - Filtering & Search

Task Queue: Celery 5.3
  - Redis broker
  - Beat scheduler
  - Result backend
  - Task routing

Language: Python 3.12
  - Type hints
  - Async support
  - Modern syntax

Database: PostgreSQL 16
  - pgvector extension
  - JSONB support
  - Full-text search
  - Row-level security ready

Cache/Broker: Redis 7
  - Session storage
  - Celery broker
  - Cache backend
  - Rate limiting

Payments: Stripe + dj-stripe
  - Subscriptions
  - Webhooks
  - Invoices
  - Payment methods

Testing:
  - pytest
  - pytest-django
  - factory_boy
  - coverage
```

### 4.3 AI & External Services

```yaml
AI Providers (Direct API integration):
  Text Generation: Google Gemini 1.5 Pro
    - API Key: GEMINI_API_KEY
    - Use: Personas, Topics, Blog posts, Social posts
    - Rate limits: Managed via Celery concurrency
    
  DNA Scraping: Perplexity
    - API Key: PERPLEXITY_API_KEY
    - Use: Company data extraction
    - Timeout: 30s
    
  Image Generation: Nanobana (Planned)
    - API Key: NANOBANA_API_KEY
    - Use: Social media visuals (PRO+ tier)
    - Status: Not yet implemented
    
  Video Generation: Veo 3 (Planned)
    - API Key: VEO_API_KEY
    - Use: Marketing videos (ULTIMATE tier + add-on)
    - Status: Phase 3

Payment Processing:
  Stripe:
    - Subscriptions
    - Webhooks
    - Customer portal
    - Test mode: sk_test_...
    - Live mode: sk_live_...

CI/CD:
  GitHub Actions:
    - Workflow: .github/workflows/deploy.yml
    - Triggers: push to main
    - Steps: build â†’ test â†’ deploy
    - Target: 72.62.92.89 via SSH

Status: â³ LiteLLM Gateway planned for Phase 2 (unified AI interface)
```

### 4.4 DevOps & Infrastructure

```yaml
Current Deployment (MVP):
  Type: VPS + Docker Compose
  Server: 72.62.92.89
  OS: Ubuntu 22.04 LTS
  
Containerization:
  Docker: 24.x
  Docker Compose: 2.x
  
Services:
  backend:
    image: Custom Django
    ports: 8000
    depends_on: [db, redis]
    
  celery_worker:
    image: Same as backend
    command: celery worker
    queues: default,quick,ai_jobs,ai_priority
    
  celery_beat:
    image: Same as backend
    command: celery beat
    
  db:
    image: pgvector/pgvector:pg16
    ports: 5432
    volumes: postgres_data
    
  redis:
    image: redis:7-alpine
    ports: 6379
    volumes: redis_data

Reverse Proxy:
  Host Nginx:
    config: /etc/nginx/sites-available/posthub
    port: 80 (HTTP only)
    upstream: http://localhost:8000
    static: /var/www/posthub/static
    media: /var/www/posthub/media

SSL/TLS:
  Status: â³ Certbot installed but not activated
  Path: /etc/letsencrypt/
  Plan: Let's Encrypt auto-renewal
  
Monitoring (Current):
  Type: Console logs + Docker logs
  Command: docker-compose logs -f
  
Monitoring (Planned):
  - Prometheus metrics
  - Grafana dashboards
  - Sentry error tracking
  - OpenTelemetry tracing

Backup:
  Database: Manual pg_dump (daily cron planned)
  Media files: Rsync to backup server (planned)
  Retention: 30 days (planned)
```

---

## 5. MODULE STRUCTURE

### 5.1 Backend Apps (Django)

```python
backend/apps/
â”œâ”€â”€ users/                     # User Management & RBAC
â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”œâ”€â”€ User (AbstractUser)
â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”œâ”€â”€ email (unique)
â”‚   â”‚   â”‚   â”œâ”€â”€ role (ADMIN/MANAGER/MARKETER/SUPERVISOR)
â”‚   â”‚   â”‚   â”œâ”€â”€ organization (FK, nullable for staff)
â”‚   â”‚   â”‚   â””â”€â”€ manager (FK, nullable - reporting hierarchy)
â”‚   â”‚   â””â”€â”€ UserProfile
â”‚   â”œâ”€â”€ serializers.py
â”‚   â”œâ”€â”€ views.py
â”‚   â”œâ”€â”€ permissions.py         # Role-based permissions
â”‚   â””â”€â”€ admin.py
â”‚
â”œâ”€â”€ organizations/             # Multi-tenancy Root
â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”œâ”€â”€ Organization
â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”œâ”€â”€ name
â”‚   â”‚   â”‚   â”œâ”€â”€ subscription_tier
â”‚   â”‚   â”‚   â”œâ”€â”€ trial_end_date
â”‚   â”‚   â”‚   â””â”€â”€ settings (JSONB)
â”‚   â”‚   â””â”€â”€ OrganizationMember (through table)
â”‚   â”œâ”€â”€ serializers.py
â”‚   â”œâ”€â”€ views.py
â”‚   â”œâ”€â”€ middleware.py          # Tenant context injection
â”‚   â””â”€â”€ utils.py               # Tenant-aware querysets
â”‚
â”œâ”€â”€ companies/                 # Company Profiles & DNA
â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”œâ”€â”€ Company
â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”œâ”€â”€ organization (FK)
â”‚   â”‚   â”‚   â”œâ”€â”€ name
â”‚   â”‚   â”‚   â”œâ”€â”€ industry
â”‚   â”‚   â”‚   â”œâ”€â”€ dna_data (JSONB - 30+ points)
â”‚   â”‚   â”‚   â””â”€â”€ dna_scraped_at
â”‚   â”‚   â””â”€â”€ CompanyDocument
â”‚   â”œâ”€â”€ serializers.py
â”‚   â”œâ”€â”€ views.py
â”‚   â””â”€â”€ tasks.py               # DNA scraping task
â”‚
â”œâ”€â”€ personas/                  # AI Personas
â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”œâ”€â”€ Persona
â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”œâ”€â”€ company (FK)
â”‚   â”‚   â”‚   â”œâ”€â”€ name
â”‚   â”‚   â”‚   â”œâ”€â”€ style_description
â”‚   â”‚   â”‚   â”œâ”€â”€ tone
â”‚   â”‚   â”‚   â”œâ”€â”€ topics (ARRAY)
â”‚   â”‚   â”‚   â”œâ”€â”€ is_active
â”‚   â”‚   â”‚   â””â”€â”€ ai_config (JSONB)
â”‚   â”œâ”€â”€ serializers.py
â”‚   â”œâ”€â”€ views.py
â”‚   â””â”€â”€ tasks.py               # Persona generation task
â”‚
â”œâ”€â”€ content/                   # Content Management
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ topic.py
â”‚   â”‚   â”‚   â”œâ”€â”€ Topic
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ persona (FK)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ title
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ description
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ status (DRAFT/APPROVED/REJECTED)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ scheduled_date
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ metadata (JSONB)
â”‚   â”‚   â”œâ”€â”€ blog_post.py
â”‚   â”‚   â”‚   â”œâ”€â”€ BlogPost
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ topic (FK)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ content (TEXT - 4-10 pages)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ status
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ word_count
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ seo_data (JSONB)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ approved_at
â”‚   â”‚   â”œâ”€â”€ social_post.py
â”‚   â”‚   â”‚   â”œâ”€â”€ SocialPost
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ blog_post (FK)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ platform (FB/IG/LI/TW/TT)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ content
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ media_url
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ scheduled_at
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ status
â”‚   â”‚   â””â”€â”€ event.py
â”‚   â”‚       â”œâ”€â”€ MarketingEvent
â”‚   â”‚       â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚       â”‚   â”œâ”€â”€ company (FK)
â”‚   â”‚       â”‚   â”œâ”€â”€ title
â”‚   â”‚       â”‚   â”œâ”€â”€ date
â”‚   â”‚       â”‚   â””â”€â”€ description
â”‚   â”œâ”€â”€ serializers/
â”‚   â”œâ”€â”€ views/
â”‚   â””â”€â”€ tasks/
â”‚       â”œâ”€â”€ topic_generation.py
â”‚       â”œâ”€â”€ blog_generation.py
â”‚       â”œâ”€â”€ social_generation.py
â”‚       â””â”€â”€ media_generation.py
â”‚
â”œâ”€â”€ billing/                   # Stripe Integration
â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”œâ”€â”€ SubscriptionTier
â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”œâ”€â”€ name (TRIAL/BASIC/PRO/ULTIMATE)
â”‚   â”‚   â”‚   â”œâ”€â”€ price_monthly
â”‚   â”‚   â”‚   â”œâ”€â”€ price_yearly
â”‚   â”‚   â”‚   â”œâ”€â”€ limits (JSONB)
â”‚   â”‚   â”‚   â””â”€â”€ features (JSONB)
â”‚   â”‚   â”œâ”€â”€ AddOn
â”‚   â”‚   â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”‚   â”‚   â”œâ”€â”€ name
â”‚   â”‚   â”‚   â”œâ”€â”€ price
â”‚   â”‚   â”‚   â””â”€â”€ description
â”‚   â”‚   â””â”€â”€ UsageTracking
â”‚   â”‚       â”œâ”€â”€ id (UUID)
â”‚   â”‚       â”œâ”€â”€ organization (FK)
â”‚   â”‚       â”œâ”€â”€ feature
â”‚   â”‚       â”œâ”€â”€ used_count
â”‚   â”‚       â””â”€â”€ reset_date
â”‚   â”œâ”€â”€ serializers.py
â”‚   â”œâ”€â”€ views.py
â”‚   â”œâ”€â”€ webhooks.py            # Stripe webhook handlers
â”‚   â””â”€â”€ tasks.py               # Subscription management
â”‚
â”œâ”€â”€ ai_gateway/                # AI Provider Abstraction
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ base.py            # AIProvider interface
â”‚   â”‚   â”œâ”€â”€ gemini.py          # GeminiProvider
â”‚   â”‚   â”œâ”€â”€ perplexity.py      # PerplexityProvider
â”‚   â”‚   â”œâ”€â”€ nanobana.py        # NanobanaProvider (planned)
â”‚   â”‚   â””â”€â”€ veo.py             # VeoProvider (planned)
â”‚   â”œâ”€â”€ gateway.py             # AIGateway class
â”‚   â”œâ”€â”€ prompts.py             # Prompt templates
â”‚   â””â”€â”€ utils.py
â”‚
â””â”€â”€ core/                      # Shared Utilities
    â”œâ”€â”€ models.py              # TimeStampedModel, SoftDeleteModel
    â”œâ”€â”€ serializers.py         # Base serializers
    â”œâ”€â”€ permissions.py         # Custom permissions
    â”œâ”€â”€ pagination.py          # Cursor pagination
    â”œâ”€â”€ exceptions.py          # Custom exceptions
    â””â”€â”€ utils.py
```

### 5.2 Frontend Modules (Angular)

```typescript
frontend/src/app/
â”œâ”€â”€ core/                      // Singleton Services
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”œâ”€â”€ token.service.ts
â”‚   â”‚   â””â”€â”€ auth.guard.ts
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ api.service.ts
â”‚   â”‚   â”œâ”€â”€ http.interceptor.ts
â”‚   â”‚   â””â”€â”€ error.interceptor.ts
â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”œâ”€â”€ role.guard.ts
â”‚   â”‚   â””â”€â”€ tenant.guard.ts
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ notification.service.ts
â”‚       â””â”€â”€ theme.service.ts
â”‚
â”œâ”€â”€ shared/                    // Reusable Components (35+)
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ button/
â”‚   â”‚   â”œâ”€â”€ card/
â”‚   â”‚   â”œâ”€â”€ modal/
â”‚   â”‚   â”œâ”€â”€ table/
â”‚   â”‚   â”œâ”€â”€ form-field/
â”‚   â”‚   â”œâ”€â”€ progress-bar/
â”‚   â”‚   â”œâ”€â”€ avatar/
â”‚   â”‚   â”œâ”€â”€ badge/
â”‚   â”‚   â”œâ”€â”€ dropdown/
â”‚   â”‚   â”œâ”€â”€ tabs/
â”‚   â”‚   â”œâ”€â”€ accordion/
â”‚   â”‚   â”œâ”€â”€ tooltip/
â”‚   â”‚   â”œâ”€â”€ alert/
â”‚   â”‚   â”œâ”€â”€ spinner/
â”‚   â”‚   â”œâ”€â”€ pagination/
â”‚   â”‚   â”œâ”€â”€ breadcrumb/
â”‚   â”‚   â”œâ”€â”€ sidebar/
â”‚   â”‚   â”œâ”€â”€ header/
â”‚   â”‚   â”œâ”€â”€ footer/
â”‚   â”‚   â”œâ”€â”€ empty-state/
â”‚   â”‚   â”œâ”€â”€ skeleton-loader/
â”‚   â”‚   â”œâ”€â”€ rich-text-editor/
â”‚   â”‚   â”œâ”€â”€ file-upload/
â”‚   â”‚   â”œâ”€â”€ date-picker/
â”‚   â”‚   â”œâ”€â”€ color-picker/
â”‚   â”‚   â”œâ”€â”€ image-cropper/
â”‚   â”‚   â”œâ”€â”€ chart/ (Chart.js wrapper)
â”‚   â”‚   â”œâ”€â”€ calendar/
â”‚   â”‚   â”œâ”€â”€ timeline/
â”‚   â”‚   â”œâ”€â”€ stepper/
â”‚   â”‚   â”œâ”€â”€ rating/
â”‚   â”‚   â”œâ”€â”€ slider/
â”‚   â”‚   â”œâ”€â”€ toggle/
â”‚   â”‚   â”œâ”€â”€ chip/
â”‚   â”‚   â””â”€â”€ divider/
â”‚   â”œâ”€â”€ directives/
â”‚   â”‚   â”œâ”€â”€ click-outside.directive.ts
â”‚   â”‚   â”œâ”€â”€ lazy-load.directive.ts
â”‚   â”‚   â””â”€â”€ autofocus.directive.ts
â”‚   â””â”€â”€ pipes/
â”‚       â”œâ”€â”€ safe-html.pipe.ts
â”‚       â”œâ”€â”€ truncate.pipe.ts
â”‚       â””â”€â”€ time-ago.pipe.ts
â”‚
â”œâ”€â”€ features/                  // Feature Modules
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ managers/
â”‚   â”‚   â”œâ”€â”€ marketers/
â”‚   â”‚   â”œâ”€â”€ system-config/
â”‚   â”‚   â””â”€â”€ analytics/
â”‚   â”œâ”€â”€ manager/
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ team/
â”‚   â”‚   â”œâ”€â”€ supervisors/
â”‚   â”‚   â””â”€â”€ quality-review/
â”‚   â”œâ”€â”€ marketer/
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ companies/
â”‚   â”‚   â”œâ”€â”€ pending-approvals/
â”‚   â”‚   â””â”€â”€ affiliate/
â”‚   â””â”€â”€ supervisor/
â”‚       â”œâ”€â”€ onboarding/
â”‚       â”œâ”€â”€ dashboard/
â”‚       â”œâ”€â”€ content-calendar/
â”‚       â”œâ”€â”€ personas/
â”‚       â”œâ”€â”€ topics/
â”‚       â”œâ”€â”€ blog-posts/
â”‚       â”œâ”€â”€ social-posts/
â”‚       â”œâ”€â”€ billing/
â”‚       â””â”€â”€ analytics/
â”‚
â””â”€â”€ store/                     // NgRx State Management
    â”œâ”€â”€ auth/
    â”‚   â”œâ”€â”€ auth.actions.ts
    â”‚   â”œâ”€â”€ auth.reducer.ts
    â”‚   â”œâ”€â”€ auth.effects.ts
    â”‚   â””â”€â”€ auth.selectors.ts
    â”œâ”€â”€ organizations/
    â”‚   â”œâ”€â”€ organizations.actions.ts
    â”‚   â”œâ”€â”€ organizations.reducer.ts
    â”‚   â”œâ”€â”€ organizations.effects.ts
    â”‚   â””â”€â”€ organizations.selectors.ts
    â”œâ”€â”€ companies/
    â”œâ”€â”€ personas/
    â”œâ”€â”€ content/
    â””â”€â”€ billing/
```

---

## 6. INTEGRATION POINTS

### 6.1 AI Providers

#### Current Implementation (MVP)

```python
# Direct API integration (no LiteLLM)
# config/settings/base.py

GEMINI_API_KEY = env('GEMINI_API_KEY')
PERPLEXITY_API_KEY = env('PERPLEXITY_API_KEY')
NANOBANA_API_KEY = env('NANOBANA_API_KEY')  # Planned
VEO_API_KEY = env('VEO_API_KEY')  # Planned

# Example usage in tasks
from google import generativeai as genai

genai.configure(api_key=settings.GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-1.5-pro')

response = model.generate_content(prompt)
```

#### Planned: AIGateway Abstraction (Phase 2)

```python
# apps/ai_gateway/gateway.py

class AIGateway:
    """
    Unified interface for AI providers with:
    - Provider fallback
    - Rate limiting
    - Cost tracking
    - Prompt template management
    """
    
    def __init__(self, provider: AIProvider):
        self.provider = provider
    
    async def generate_text(
        self, 
        prompt_key: str, 
        context: dict,
        **kwargs
    ) -> str:
        """Generate text using selected provider"""
        template = await self.get_prompt_template(prompt_key)
        rendered_prompt = template.render(context)
        
        return await self.provider.complete(
            prompt=rendered_prompt,
            **kwargs
        )
    
    async def generate_image(
        self, 
        prompt: str,
        **kwargs
    ) -> str:
        """Generate image using selected provider"""
        return await self.provider.generate_image(
            prompt=prompt,
            **kwargs
        )

# Usage in Celery tasks
gateway = AIGateway(provider=GeminiProvider())
result = await gateway.generate_text(
    prompt_key='blog_post_generation',
    context={
        'persona': persona,
        'topic': topic,
        'dna': company.dna_data
    }
)
```

**Status:** â³ Phase 2 implementation planned

### 6.2 Stripe Integration

```python
# apps/billing/webhooks.py

from djstripe import webhooks

@webhooks.handler('customer.subscription.created')
def handle_subscription_created(event, **kwargs):
    """
    Handle new subscription creation
    - Update organization tier
    - Enable features
    - Send welcome email
    """
    subscription = event.data['object']
    # ... implementation

@webhooks.handler('customer.subscription.updated')
def handle_subscription_updated(event, **kwargs):
    """
    Handle subscription changes
    - Update tier limits
    - Handle upgrades/downgrades
    - Proration handling
    """
    # ... implementation

@webhooks.handler('invoice.payment_failed')
def handle_payment_failed(event, **kwargs):
    """
    Handle payment failures
    - Mark subscription as PAST_DUE
    - Pause add-ons
    - Send notification
    """
    # ... implementation

@webhooks.handler('customer.subscription.deleted')
def handle_subscription_cancelled(event, **kwargs):
    """
    Handle subscription cancellation
    - Disable features
    - Preserve data (grace period)
    - Send exit survey
    """
    # ... implementation
```

### 6.3 External APIs Summary

```yaml
Google Gemini 1.5 Pro:
  Purpose: Text generation (personas, topics, blog posts, social posts)
  Authentication: API Key
  Rate Limits: Managed via Celery concurrency (2 workers)
  Endpoint: https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro
  Timeout: 120s
  Retry: 3x with exponential backoff
  
Perplexity:
  Purpose: Company DNA scraping
  Authentication: API Key
  Rate Limits: 100 requests/day (free tier)
  Endpoint: https://api.perplexity.ai
  Timeout: 30s
  Retry: 2x

Nanobana (Planned):
  Purpose: Image generation (PRO+ tier)
  Authentication: API Key
  Rate Limits: TBD
  Status: Not yet implemented
  
Veo 3 (Planned):
  Purpose: Video generation (ULTIMATE tier + add-on)
  Authentication: API Key
  Rate Limits: TBD
  Status: Phase 3

Stripe:
  Purpose: Payment processing, subscriptions, webhooks
  Authentication: Secret Key
  Test Mode: sk_test_51QWz...
  Live Mode: sk_live_51QWz...
  Webhook Secret: whsec_...
  Endpoint: /api/billing/webhook/
  
GitHub:
  Purpose: CI/CD via GitHub Actions
  Authentication: SSH key
  Trigger: push to main
  Target: 72.62.92.89
```

---

## 7. SCALABILITY PATTERNS

### 7.1 Current Architecture (MVP)

```yaml
Single VPS Deployment:
  Server: 72.62.92.89
  Resources:
    - CPU: 4 cores
    - RAM: 16 GB
    - Disk: 500 GB SSD
  
  Services:
    - Django (1 instance, port 8000)
    - Celery Workers:
        * quick: 4 workers
        * ai_jobs: 2 workers
        * ai_priority: 2 workers
        * scheduled: 1 worker
    - PostgreSQL (1 instance)
    - Redis (1 instance)
  
  Limitations:
    - Single point of failure
    - No auto-scaling
    - Manual resource management
    - Limited to ~1000 concurrent users
    - ~50,000 posts/month capacity

Status: âœ… Adequate for MVP (100-1000 users)
```

### 7.2 Horizontal Scaling Strategy (Planned - Phase 2)

```yaml
Kubernetes Cluster Architecture:

Frontend Tier:
  - Nginx Ingress Controller
  - Multiple frontend pods (Angular build)
  - Auto-scaling: 2-10 replicas
  - CDN: CloudFlare (planned)

API Tier:
  - Django API pods
  - Auto-scaling: 3-20 replicas (HPA)
  - Load balancing: Round-robin
  - Health checks: /api/health/

Background Workers:
  - Celery worker deployment
  - Separate deployments per queue
  - KEDA auto-scaling:
      * quick: 2-8 workers (based on queue length)
      * ai_jobs: 2-10 workers
      * ai_priority: 2-5 workers
  
Database Tier:
  - PostgreSQL Primary-Replica setup
  - Read replicas: 2-5 (based on load)
  - Connection pooling: PgBouncer
  - Backup: Daily snapshots

Cache/Broker:
  - Redis Cluster (3-5 nodes)
  - Sentinel for HA
  - Separate Redis for cache vs broker

Storage:
  - Object storage (S3-compatible)
  - CDN for media delivery
  - Static assets: CloudFlare CDN

Target Capacity:
  - 10,000+ concurrent users
  - 1,000,000+ posts/month
  - 99.9% uptime SLA

Status: â³ Planned for post-funding
```

### 7.3 Database Scaling

```yaml
Current:
  - Single PostgreSQL 16 instance
  - pgvector extension
  - 93 tables
  - Row-based multi-tenancy (organization FK)

Phase 2 (Read Scaling):
  - Primary-Replica setup
  - Read queries â†’ Replicas
  - Write queries â†’ Primary
  - Django database router
  - Connection pooling (PgBouncer)

Phase 3 (Sharding - if needed):
  - Shard by organization_id
  - Citus extension for distributed PostgreSQL
  - Or: Separate tenant databases for largest customers
```

### 7.4 Caching Strategy

```yaml
Current:
  - Redis 7 single instance
  - Django cache framework
  - Session storage

Planned:
  L1 Cache (In-memory):
    - Django cache per pod
    - TTL: 60s
    - Size: 100MB per pod
  
  L2 Cache (Redis):
    - Distributed cache
    - TTL: 5-60 minutes
    - Eviction: LRU
    
  L3 Cache (CDN):
    - Static assets
    - Media files
    - API responses (selected endpoints)
    - TTL: 1 hour - 7 days

Cache Keys:
  - Format: posthub:{resource}:{id}:{version}
  - Example: posthub:company:uuid:v1
  - Invalidation: On update/delete
```

### 7.5 Rate Limiting

```yaml
Current:
  Status: Not implemented

Planned:
  API Rate Limits (per user):
    - Authenticated: 1000 req/hour
    - Supervisor: 500 req/hour
    - Public: 100 req/hour
  
  AI Generation Limits (per organization, per tier):
    - TRIAL: 12 posts/month
    - BASIC: 12 posts/month
    - PRO: 24 posts/month
    - ULTIMATE: 72 posts/month
  
  Implementation:
    - Django ratelimit package
    - Redis backend
    - Token bucket algorithm
    - Headers: X-RateLimit-Remaining, X-RateLimit-Reset
```

---

## 8. DEPLOYMENT ARCHITECTURE

### 8.1 Current Deployment (MVP - Production)

```yaml
Environment: Production VPS
Server: 72.62.92.89
OS: Ubuntu 22.04 LTS

Architecture:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VPS: 72.62.92.89                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Host Nginx (Port 80)                                           â”‚
â”‚  â”œâ”€â”€ Config: /etc/nginx/sites-available/posthub                â”‚
â”‚  â”œâ”€â”€ Upstream: http://localhost:8000                            â”‚
â”‚  â”œâ”€â”€ Static: /var/www/posthub/static                            â”‚
â”‚  â””â”€â”€ Media: /var/www/posthub/media                              â”‚
â”‚                                                                  â”‚
â”‚  Docker Compose (Production)                                    â”‚
â”‚  â”œâ”€â”€ backend:                                                   â”‚
â”‚  â”‚   â”œâ”€â”€ Image: Custom Django (Python 3.12)                    â”‚
â”‚  â”‚   â”œâ”€â”€ Port: 8000                                             â”‚
â”‚  â”‚   â”œâ”€â”€ Command: gunicorn                                      â”‚
â”‚  â”‚   â””â”€â”€ Workers: 4                                             â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€â”€ celery_worker:                                             â”‚
â”‚  â”‚   â”œâ”€â”€ Image: Same as backend                                â”‚
â”‚  â”‚   â”œâ”€â”€ Queues: default,quick,ai_jobs,ai_priority             â”‚
â”‚  â”‚   â””â”€â”€ Concurrency: quick=4, ai=2                            â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€â”€ celery_beat:                                               â”‚
â”‚  â”‚   â”œâ”€â”€ Image: Same as backend                                â”‚
â”‚  â”‚   â””â”€â”€ Command: celery beat                                  â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€â”€ db:                                                        â”‚
â”‚  â”‚   â”œâ”€â”€ Image: pgvector/pgvector:pg16                         â”‚
â”‚  â”‚   â”œâ”€â”€ Port: 5432                                             â”‚
â”‚  â”‚   â”œâ”€â”€ Volume: postgres_data                                 â”‚
â”‚  â”‚   â””â”€â”€ Database: posthub_prod                                â”‚
â”‚  â”‚                                                               â”‚
â”‚  â””â”€â”€ redis:                                                     â”‚
â”‚      â”œâ”€â”€ Image: redis:7-alpine                                 â”‚
â”‚      â”œâ”€â”€ Port: 6379                                             â”‚
â”‚      â””â”€â”€ Volume: redis_data                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Network:
  - Public IP: 72.62.92.89
  - Protocol: HTTP (port 80)
  - SSL: Not yet activated (Certbot ready)
  - DNS: Pending domain configuration

Volumes:
  - /var/lib/docker/volumes/posthub_postgres_data
  - /var/lib/docker/volumes/posthub_redis_data
  - /var/www/posthub/media
  - /var/www/posthub/static

Monitoring:
  - Docker logs: docker-compose logs -f
  - System logs: /var/log/nginx/
  - Application logs: Console output
  - Celery monitoring: None (Flower not active)

Backup:
  - Status: Manual backups only
  - Database: pg_dump (on demand)
  - Media files: Not backed up regularly
  - Plan: Automated daily backups via cron

Status: âœ… Functional, â³ Needs SSL + monitoring
```

### 8.2 Docker Configuration

#### docker-compose.prod.yml

```yaml
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: posthub_backend
    ports:
      - "8000:8000"
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/posthub_prod
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      - db
      - redis
    restart: unless-stopped
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: posthub_celery_worker
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/posthub_prod
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
      - backend
    restart: unless-stopped
    command: >
      celery -A config worker 
      --loglevel=info 
      --queues=default,quick,ai_jobs,ai_priority 
      --concurrency=8

  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: posthub_celery_beat
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/posthub_prod
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
      - backend
    restart: unless-stopped
    command: celery -A config beat --loglevel=info

  db:
    image: pgvector/pgvector:pg16
    container_name: posthub_db
    environment:
      - POSTGRES_DB=posthub_prod
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: posthub_redis
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    command: redis-server --appendonly yes

volumes:
  postgres_data:
  redis_data:
  static_volume:
  media_volume:
```

#### Nginx Configuration

```nginx
# /etc/nginx/sites-available/posthub

upstream backend {
    server localhost:8000;
}

server {
    listen 80;
    server_name 72.62.92.89;  # Replace with domain when ready
    
    client_max_body_size 100M;
    
    # Static files
    location /static/ {
        alias /var/www/posthub/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Media files
    location /media/ {
        alias /var/www/posthub/media/;
        expires 7d;
        add_header Cache-Control "public";
    }
    
    # API
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for long-running AI tasks
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
    }
}

# SSL configuration (ready, not active)
# server {
#     listen 443 ssl http2;
#     server_name posthub.work www.posthub.work;
#     
#     ssl_certificate /etc/letsencrypt/live/posthub.work/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/posthub.work/privkey.pem;
#     
#     # ... (same configuration as above)
# }
```

### 8.3 CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml

name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no root@72.62.92.89 << 'EOF'
            cd /opt/posthub
            git pull origin main
            docker-compose -f docker-compose.prod.yml build
            docker-compose -f docker-compose.prod.yml up -d
            docker-compose -f docker-compose.prod.yml exec -T backend python manage.py migrate
            docker-compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput
          EOF
      
      - name: Health Check
        run: |
          sleep 10
          curl -f http://72.62.92.89/api/health/ || exit 1

Status: âœ… Basic pipeline functional
```

### 8.4 Environment Variables

```bash
# .env.production (on server)

# Django
DEBUG=False
SECRET_KEY=your-secret-key-here
ALLOWED_HOSTS=72.62.92.89,posthub.work,www.posthub.work
DJANGO_SETTINGS_MODULE=config.settings.production

# Database
DATABASE_URL=postgresql://postgres:your-password@db:5432/posthub_prod
POSTGRES_DB=posthub_prod
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your-password

# Redis
REDIS_URL=redis://redis:6379/0

# Celery
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/1

# AI Providers
GEMINI_API_KEY=AIzaSy...
PERPLEXITY_API_KEY=pplx-...
NANOBANA_API_KEY=AIza...  # Planned
VEO_API_KEY=AIza...  # Planned

# Stripe
STRIPE_SECRET_KEY=sk_live_51QWz...
STRIPE_PUBLISHABLE_KEY=pk_live_51QWz...
STRIPE_WEBHOOK_SECRET=whsec_...
DJSTRIPE_WEBHOOK_SECRET=whsec_...

# Email (planned)
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=noreply@posthub.work
EMAIL_HOST_PASSWORD=your-app-password

# Sentry (planned, currently empty)
SENTRY_DSN=

# Storage
MEDIA_ROOT=/app/media
STATIC_ROOT=/app/staticfiles

# Security
SECURE_SSL_REDIRECT=False  # Will be True after SSL activation
SESSION_COOKIE_SECURE=False  # Will be True after SSL
CSRF_COOKIE_SECURE=False  # Will be True after SSL
```

### 8.5 Planned Migration to Kubernetes (Phase 2)

```yaml
Target Architecture:

Namespace: posthub-prod

Deployments:
  - frontend-deployment (Angular)
      * Replicas: 3
      * HPA: 3-10 (CPU > 70%)
      * Image: nginx:alpine + Angular build
      
  - backend-deployment (Django API)
      * Replicas: 5
      * HPA: 5-20 (CPU > 60%)
      * Image: posthub/backend:latest
      
  - celery-worker-quick
      * Replicas: 2
      * KEDA: 2-8 (queue length)
      
  - celery-worker-ai
      * Replicas: 2
      * KEDA: 2-10 (queue length)
      
  - celery-beat
      * Replicas: 1 (StatefulSet)

Services:
  - frontend-service (ClusterIP)
  - backend-service (ClusterIP)
  - postgres-service (ClusterIP)
  - redis-service (ClusterIP)

Ingress:
  - nginx-ingress-controller
  - SSL: cert-manager + Let's Encrypt
  - Routes:
      * / â†’ frontend-service
      * /api â†’ backend-service

StatefulSets:
  - postgres-statefulset
      * Replicas: 3 (Primary + 2 Replicas)
      * Storage: PersistentVolumeClaim (SSD)
      
  - redis-statefulset
      * Replicas: 3 (Redis Cluster)
      * Sentinel: Yes

ConfigMaps:
  - backend-config
  - celery-config
  - nginx-config

Secrets:
  - database-credentials
  - redis-credentials
  - ai-api-keys
  - stripe-keys

Monitoring:
  - Prometheus Operator
  - Grafana
  - Loki (logs)
  - Jaeger (tracing)

Backup:
  - Velero (cluster backup)
  - pg_dump â†’ S3 (daily)
  - Redis snapshot â†’ S3 (hourly)

Status: â³ Planned for post-funding (Q2 2026)
Cost Estimate: $500-1000/month (managed Kubernetes)
```

---

## 9. SECURITY ARCHITECTURE

### 9.1 Authentication & Authorization

```yaml
Authentication:
  Method: JWT (JSON Web Tokens)
  Library: djangorestframework-simplejwt
  
  Access Token:
    Expiry: 60 minutes
    Payload: user_id, email, role, organization_id
    Algorithm: HS256
    
  Refresh Token:
    Expiry: 7 days
    Rotation: On refresh
    Blacklist: On logout
    
  Flow:
    1. POST /api/auth/login/ â†’ {access, refresh}
    2. Include: Authorization: Bearer <access_token>
    3. On expiry: POST /api/auth/refresh/ â†’ {access}
    4. Logout: POST /api/auth/logout/ â†’ Blacklist refresh

Authorization (RBAC):
  Roles:
    - ADMIN: Full system access
    - MANAGER: Team management, view all under them
    - MARKETER: Assigned supervisors only
    - SUPERVISOR: Own organization only
    
  Permission Checks:
    1. Role-based: User.role == required_role
    2. Tenant-based: Object.organization == User.organization
    3. Hierarchy: Manager â†’ Marketer â†’ Supervisor
    
  Implementation:
    - Django permissions
    - DRF permission classes
    - Tenant middleware
    - QuerySet filtering
```

### 9.2 Data Security

```yaml
Tenant Isolation:
  Strategy: Row-based multi-tenancy
  
  Implementation:
    - All models have organization FK
    - Middleware injects tenant context
    - Queryset filtering via manager
    - Foreign key validation
    
  Example:
    class TenantAwareModel(models.Model):
        organization = models.ForeignKey(Organization)
        
        objects = TenantAwareManager()  # Auto-filters by tenant
        
        class Meta:
            abstract = True

Encryption:
  In Transit:
    Current: HTTP only (SSL pending)
    Planned: TLS 1.3 (Let's Encrypt)
    HSTS: Planned (max-age=31536000)
    
  At Rest:
    Database: PostgreSQL encryption at rest (if enabled on host)
    Backups: Encrypted with GPG (planned)
    Secrets: Environment variables + Docker secrets
    
  Sensitive Data:
    API Keys: Environment variables
    Passwords: Django's PBKDF2 (default)
    Payment Data: Stored by Stripe only (PCI compliant)

Data Privacy:
  GDPR Compliance:
    - User consent tracking
    - Right to access (data export)
    - Right to erasure (soft delete)
    - Data portability (JSON export)
    
  Anonymization:
    - Soft delete with is_deleted flag
    - Hard delete after 90 days (planned)
    - Anonymize emails on request
```

### 9.3 API Security

```yaml
Input Validation:
  - DRF serializers
  - Django form validation
  - Type hints + Pydantic (planned)
  - SQL injection: ORM prevents
  - XSS: DRF auto-escapes
  
Rate Limiting:
  Current: Not implemented
  Planned:
    - django-ratelimit
    - Redis backend
    - Per user/IP
    - Gradual backoff
    
CORS:
  - django-cors-headers
  - Allowed origins: posthub.work, www.posthub.work
  - Allowed methods: GET, POST, PUT, PATCH, DELETE
  - Credentials: True (for cookies)
  
CSRF:
  - Django CSRF middleware
  - Token in cookie
  - Header: X-CSRFToken
  - Exempted: /api/auth/*, /api/billing/webhook/

Headers:
  Current:
    - X-Content-Type-Options: nosniff
    - X-Frame-Options: DENY
    - Referrer-Policy: same-origin
    
  Planned (after SSL):
    - Strict-Transport-Security: max-age=31536000
    - Content-Security-Policy: (custom policy)
```

### 9.4 Secrets Management

```yaml
Current:
  Method: Environment variables
  Storage: .env.production (on server)
  Access: Root user only
  Backup: Manual copy to secure location
  
Planned (Phase 2):
  Method: Kubernetes Secrets + External Secrets Operator
  Storage: AWS Secrets Manager / HashiCorp Vault
  Rotation: Automatic (90 days)
  Access: RBAC + audit logs
  
Secret Types:
  - Database credentials
  - Redis password
  - AI API keys
  - Stripe keys
  - JWT secret
  - Email credentials
  - Webhook secrets
```

### 9.5 Monitoring & Logging

```yaml
Current:
  - Console logs (Django DEBUG=False)
  - Docker logs (docker-compose logs)
  - Nginx access/error logs
  - No centralized logging
  - No error tracking
  - No alerting

Planned (Phase 2):
  Application Monitoring:
    - Sentry: Error tracking + performance
    - Prometheus: Metrics collection
    - Grafana: Dashboards + alerting
    
  Log Aggregation:
    - Loki: Log aggregation
    - Promtail: Log shipping
    - Grafana: Log exploration
    
  Tracing:
    - OpenTelemetry: Distributed tracing
    - Jaeger: Trace visualization
    
  Security Monitoring:
    - Failed login attempts
    - Unusual API patterns
    - Privilege escalation attempts
    - Data export events
    
  Alerts:
    - High error rate
    - Slow response times
    - Failed background jobs
    - Security events
    - Low disk space
    - Database connection issues
```

---

## 10. MONITORING & OBSERVABILITY

### 10.1 Current State (MVP)

```yaml
Logging:
  Type: Console logs + Docker logs
  Storage: Local files (rotated daily)
  Retention: 7 days
  
  Access:
    - SSH into server
    - docker-compose logs -f [service]
    - tail -f /var/log/nginx/access.log
    
Health Checks:
  Endpoint: /api/health/
  Checks:
    - Database connectivity
    - Redis connectivity
    - Celery workers alive
  
  Response:
    {
      "status": "healthy",
      "database": "ok",
      "redis": "ok",
      "celery": "ok"
    }

Monitoring:
  - Manual server checks
  - No automatic alerts
  - No performance metrics
  - No error tracking
  - No uptime monitoring

Status: âš ï¸ Basic, needs improvement
```

### 10.2 Planned Observability Stack (Phase 2)

```yaml
Metrics Collection:
  Tool: Prometheus
  Exporters:
    - Django Prometheus (django-prometheus)
    - Node Exporter (system metrics)
    - PostgreSQL Exporter
    - Redis Exporter
    - Celery Exporter
    
  Metrics:
    - Request rate, latency, errors
    - Database connections, query time
    - Cache hit/miss ratio
    - Celery queue length, task duration
    - System CPU, memory, disk

Visualization:
  Tool: Grafana
  Dashboards:
    - Overview: System health
    - API: Request metrics
    - Database: Query performance
    - Celery: Task metrics
    - Business: Subscriptions, content generation
    
  Alerts:
    - High error rate (>5%)
    - Slow response time (p95 > 1s)
    - Database connection pool exhausted
    - Celery queue backlog (>100)
    - Disk usage > 80%

Log Aggregation:
  Tool: Loki + Promtail
  
  Log Sources:
    - Django application logs
    - Celery worker logs
    - Nginx access/error logs
    - PostgreSQL logs
    - System logs
    
  Features:
    - Centralized search
    - Log streaming
    - Correlation with metrics
    - Alert on log patterns

Error Tracking:
  Tool: Sentry
  
  Features:
    - Real-time error alerts
    - Stack traces
    - Breadcrumbs (user actions)
    - Release tracking
    - Performance monitoring
    
  Integration:
    - Django (sentry-sdk)
    - Celery
    - Frontend (Angular)

Distributed Tracing:
  Tool: OpenTelemetry + Jaeger
  
  Traces:
    - API request â†’ Database query
    - API request â†’ Celery task
    - Celery task â†’ AI API call
    
  Metrics:
    - End-to-end latency
    - Service dependencies
    - Bottleneck identification

Uptime Monitoring:
  Tool: UptimeRobot / Pingdom
  
  Checks:
    - HTTP: https://posthub.work/
    - API: https://posthub.work/api/health/
    - Frequency: 5 minutes
    - Notifications: Email, Slack

Status: â³ Planned for Phase 2 (Q1 2026)
```

---

## 11. DECISION LOG

### 11.1 Architecture Decisions

| Decision | Rationale | Alternatives Considered | Status |
|----------|-----------|------------------------|---------|
| **Modular Monolith** | Faster development, easier debugging, prepare for extraction | Microservices (too complex for MVP) | âœ… Active |
| **Row-based Multi-tenancy** | Simpler than schema-per-tenant, easier migration | Schema-per-tenant, Database-per-tenant | âœ… Active |
| **Organization â†’ Company** | Support multi-company per tenant | Single company per tenant | âœ… Active |
| **PostgreSQL + pgvector** | Future AI embeddings, JSONB, full-text search | MySQL, MongoDB | âœ… Active |
| **Celery + Redis** | Proven, scalable, good docs | RabbitMQ, AWS SQS | âœ… Active |
| **JWT Auth** | Stateless, scalable | Session-based auth | âœ… Active |
| **Angular 19** | Modern, type-safe, enterprise-ready | React, Vue | âœ… Active |
| **Tailwind CSS** | Utility-first, fast prototyping, small bundle | Bootstrap, Material UI | âœ… Active |
| **Direct AI APIs** | Simpler for MVP, lower latency | LiteLLM gateway | âœ… Active |
| **Docker Compose (MVP)** | Fast setup, low cost | Kubernetes (overkill for MVP) | âœ… Active |
| **VPS (MVP)** | Low cost ($50/mo), sufficient for 100-1000 users | Managed Kubernetes ($500+/mo) | âœ… Active |
| **Stripe** | Best subscription management, webhooks | PayPal, Chargebee | âœ… Active |

### 11.2 Technical Debt

| Item | Impact | Priority | Plan |
|------|--------|----------|------|
| **No SSL/TLS** | High security risk | ğŸ”´ P0 | Activate Certbot (1 day) |
| **No Monitoring** | Can't detect issues | ğŸŸ  P1 | Sentry + basic metrics (1 week) |
| **No Automated Backups** | Data loss risk | ğŸŸ  P1 | Cron job + S3 (2 days) |
| **No Rate Limiting** | DDoS vulnerability | ğŸŸ¡ P2 | django-ratelimit (3 days) |
| **No Error Tracking** | Slow bug fixes | ğŸŸ¡ P2 | Sentry integration (1 day) |
| **LiteLLM Missing** | No AI fallback | ğŸŸ¢ P3 | Phase 2 feature |
| **SSE Progress** | Poor UX for AI tasks | ğŸŸ¡ P2 | Phase 2 feature |
| **Image/Video Gen** | Missing features | ğŸŸ¢ P3 | Phase 3 feature |

### 11.3 Planned Improvements

```yaml
Phase 1 (Current - Q4 2025):
  âœ… Core functionality
  âœ… Multi-tenancy
  âœ… Celery tasks
  âœ… Basic deployment
  â³ SSL activation
  â³ Basic monitoring

Phase 2 (Q1 2026):
  ğŸ¯ Sentry error tracking
  ğŸ¯ Prometheus + Grafana
  ğŸ¯ Automated backups
  ğŸ¯ Rate limiting
  ğŸ¯ SSE progress updates
  ğŸ¯ AIGateway abstraction
  ğŸ¯ Image generation (Nanobana)

Phase 3 (Q2 2026):
  ğŸ¯ Kubernetes migration
  ğŸ¯ Auto-scaling
  ğŸ¯ CDN integration
  ğŸ¯ Video generation (Veo 3)
  ğŸ¯ Advanced analytics
  ğŸ¯ API for enterprise

Phase 4 (Q3 2026+):
  ğŸ¯ Multi-region deployment
  ğŸ¯ White-label support
  ğŸ¯ Mobile apps
  ğŸ¯ AI embeddings search
```

---

## 12. MIGRATION PATH

### 12.1 Current â†’ Kubernetes Migration

```yaml
Step 1: Preparation (1-2 weeks)
  - Containerize all services âœ…
  - Write Kubernetes manifests
  - Setup CI/CD pipeline for K8s
  - Prepare migration checklist

Step 2: Infrastructure Setup (1 week)
  - Provision Kubernetes cluster (EKS/GKE/AKS)
  - Setup ingress controller (nginx)
  - Setup cert-manager (SSL)
  - Setup storage classes (PVC)

Step 3: Database Migration (1 day - planned downtime)
  - Dump production database
  - Restore to K8s PostgreSQL
  - Verify data integrity
  - Setup replication

Step 4: Application Deployment (1 day)
  - Deploy backend pods
  - Deploy Celery workers
  - Deploy Redis cluster
  - Deploy frontend
  - Configure ingress

Step 5: Cutover (1 hour - planned downtime)
  - Update DNS records
  - Switch traffic to K8s
  - Monitor for issues
  - Rollback plan ready

Step 6: Monitoring Setup (1 week)
  - Deploy Prometheus
  - Deploy Grafana
  - Deploy Loki
  - Configure alerts
  - Train team

Step 7: Optimization (2 weeks)
  - Fine-tune HPA
  - Optimize resource requests/limits
  - Setup auto-scaling policies
  - Performance testing

Total Timeline: 6-8 weeks
Estimated Cost: $500-1000/month
Prerequisite: Funding secured
```

### 12.2 Data Migration Strategy

```yaml
Zero-Downtime Approach:
  
  Phase 1: Parallel Run
    - K8s cluster running
    - VPS still serving traffic
    - Database replication: VPS â†’ K8s
    - Duration: 1-2 days
    
  Phase 2: Shadow Traffic
    - Send 10% traffic to K8s
    - Compare responses
    - Monitor errors
    - Duration: 1 day
    
  Phase 3: Gradual Cutover
    - 25% â†’ 50% â†’ 75% â†’ 100%
    - Monitor metrics at each step
    - Rollback ready
    - Duration: 2 days
    
  Phase 4: VPS Decommission
    - Keep VPS as backup (7 days)
    - Then shutdown
    - Delete resources

Rollback Plan:
  - DNS switch back to VPS (5 minutes)
  - Database resync (if needed)
  - Alert customers of brief downtime
```

---

## ğŸ“Š ARCHITECTURE HEALTH METRICS

### Current State Assessment

| Category | Score | Notes |
|----------|-------|-------|
| **Scalability** | 6/10 | VPS limits at ~1000 users |
| **Reliability** | 7/10 | Single point of failure |
| **Security** | 5/10 | No SSL, basic auth only |
| **Monitoring** | 3/10 | Console logs only |
| **Performance** | 7/10 | Good for current load |
| **Maintainability** | 8/10 | Clean code, modular |
| **Documentation** | 9/10 | Comprehensive docs |
| **Cost Efficiency** | 9/10 | $50/mo for VPS |

**Overall:** 6.75/10 - **Good for MVP, needs Phase 2 improvements**

---

## ğŸ¯ IMMEDIATE ACTION ITEMS

### Critical (Do Now)

1. âœ… ~~Deploy to VPS~~ (DONE)
2. âœ… ~~Setup Docker Compose~~ (DONE)
3. ğŸ”´ **Activate SSL with Certbot** (1 day)
4. ğŸ”´ **Setup automated database backups** (1 day)
5. ğŸ”´ **Configure Sentry for error tracking** (1 day)

### High Priority (Next 2 Weeks)

6. ğŸŸ  Implement rate limiting
7. ğŸŸ  Setup basic monitoring (Prometheus)
8. ğŸŸ  Configure log rotation
9. ğŸŸ  Write deployment runbook
10. ğŸŸ  Conduct security audit

### Medium Priority (Phase 2)

11. ğŸŸ¡ Implement SSE progress updates
12. ğŸŸ¡ Migrate to Kubernetes
13. ğŸŸ¡ Setup CDN (CloudFlare)
14. ğŸŸ¡ Add image generation (Nanobana)
15. ğŸŸ¡ Implement AIGateway abstraction

---

*Tento dokument je LIVE a reflektuje skuteÄnÃ½ stav systÃ©mu.*  
*Verze 2.1.0 | PoslednÃ­ aktualizace: December 17, 2025*  
*AktualizovÃ¡no na zÃ¡kladÄ› skuteÄnÃ©ho VPS deployment s Docker Compose*